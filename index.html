<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Dome Keeper</title>
    <script src="coi-serviceworker.js"></script>
    <style>
        body {
            touch-action: none;
            margin: 0;
            border: 0 none;
            padding: 0;
            text-align: center;
            background-color: black;
        }

        #canvas {
            display: block;
            margin: 0;
            color: white;
        }

        #canvas:focus {
            outline: none;
        }

        .godot {
            font-family: 'Noto Sans', 'Droid Sans', Arial, sans-serif;
            color: #e0e0e0;
            background-color: #3b3943;
            border: 1px solid #45434e;
        }

        #status {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
        }

        #status-progress {
            width: 366px;
            height: 7px;
            background-color: #38363A;
            border: 1px solid #444246;
            padding: 1px;
            visibility: visible;
        }

        #status-progress-inner {
            height: 100%;
            width: 0;
            background-color: #202020;
            transition: width 0.5s linear;
        }

        #status-notice {
            margin: 0 100px;
            line-height: 1.3;
            visibility: visible;
            padding: 4px 6px;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <div id="status">
        <div id="status-progress" style="display: none;">
            <div id="status-progress-inner"></div>
        </div>
        <div id="status-notice" class="godot" style="display: none;"></div>
    </div>

    <script src="index.js"></script>
    <script>
        const statusProgress = document.getElementById('status-progress');
        const statusProgressInner = document.getElementById('status-progress-inner');
        const statusNotice = document.getElementById('status-notice');

        function setStatusMode(mode) {
            [statusProgress, statusNotice].forEach(e => e.style.display = 'none');
            if (mode === 'progress') statusProgress.style.display = 'block';
            else if (mode === 'notice') statusNotice.style.display = 'block';
        }

        async function startStitchedGame() {
            setStatusMode('progress');
            const totalParts = 20;
            const chunks = [];
            const baseUrl = "https://q8j-dev.github.io/dome-game/pck/index.pck.part";

            try {
                for (let i = 1; i <= totalParts; i++) {
                    const partNum = i.toString().padStart(2, '0');
                    const response = await fetch(baseUrl + partNum);
                    if (!response.ok) throw new Error(`Failed to load part ${partNum}`);
                    const blob = await response.blob();
                    chunks.push(blob);
                    statusProgressInner.style.width = `${(i / totalParts) * 100}%`;
                }

                const fullPck = new Blob(chunks, { type: "application/octet-stream" });
                const pckUrl = URL.createObjectURL(fullPck);

                const GODOT_CONFIG = {
                    "args": [],
                    "canvasResizePolicy": 2,
                    "executable": "https://cdn.jsdelivr.net/gh/q8j-dev/dome-game-upd@main/index.wasm",
                    "mainPack": pckUrl,
                    "focusCanvas": true
                };

                const engine = new Engine(GODOT_CONFIG);
                engine.startGame().then(() => {
                    statusProgress.style.display = 'none';
                });

            } catch (err) {
                statusNotice.innerText = err.message || err;
                setStatusMode('notice');
            }
        }

        startStitchedGame();
    </script>
</body>

</html>